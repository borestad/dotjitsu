#!/usr/bin/env bash
set -euo pipefail

# Improved cask-info
# - avoid --no-hscroll so long URLs are not truncated
# - provide a preview pane that shows the full homepage (or whole row)
# - detect common delimiters and normalize whitespace

FZF_DEFAULT_OPTS='--layout=reverse --border --inline-info --pointer=Â» --height=100'
export FZF_DEFAULT_OPTS

query="${1:-}"
CACHE_FILE="${HOME}/.config/cache/brew-cask.txt"

if [[ ! -f "$CACHE_FILE" ]]; then
  echo "Cache file not found: $CACHE_FILE" >&2
  exit 1
fi

# Decide whether the file already uses a '|' delimiter or tabs; otherwise normalize
if grep -q '|' "$CACHE_FILE"; then
  USE_TRANSFORM=false
elif grep -q $'\t' "$CACHE_FILE"; then
  USE_TRANSFORM=false
else
  USE_TRANSFORM=true
fi

fzf_cmd_opts=(
  --reverse
  -e
  --height=100
  +s
  --bind=ctrl-s:toggle-sort
  --delimiter='|'
  --with-nth=1,2
  --preview='printf "%s" {} | awk -F"|" '\''{ orig=$0; for(i=1;i<=NF;i++) gsub(/^[ \t]+|[ \t]+$/,"",$i); printf "Name: %s\nDesc: %s\nHomepage: %s\n\nFull row:\n%s\n", ($1? $1:"-"), ($2? $2:"-"), ($3? $3:"-"), orig }'\'' '
  --preview-window=right:60%
)

if $USE_TRANSFORM; then
  # collapse multiple whitespace into " | " so we get three columns: name | desc | homepage
  sed -E 's/[[:space:]]{2,}/ | /g' "$CACHE_FILE" | fzf "${fzf_cmd_opts[@]}" -q "$query"
else
  cat "$CACHE_FILE" | fzf "${fzf_cmd_opts[@]}" -q "$query"
fi
