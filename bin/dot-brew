#!/bin/bash
set -Eeuo pipefail

# Setup
LOG_LOCATION="$HOME/logs/brew"
TERM="xterm-256color"
mkdir -p $LOG_LOCATION
exec > >(tee -i $LOG_LOCATION/dot-brew-`date +%F--%H%M%S`.log)
exec 2>&1


cd "$(dirname $0)"/..

t () { date "+%F %H:%M:%S"; }

# Update brew itself
$HOME/.dotjitsu/bin/hr -
echo "‚ú® brew update"
echo
/opt/homebrew/bin/brew -v update

# Install Brewfile formulas
$HOME/.dotjitsu/bin/hr -
echo "‚ú® brew bundle (Brewfile)"
echo
/opt/homebrew/bin/brew -v bundle --file=$HOME/.dotjitsu/Brewfile

# Update installed bundles (even those not in Brew/Caskfile
$HOME/.dotjitsu/bin/hr -
echo "‚ú® brew upgrade"
echo
/opt/homebrew/bin/brew -v upgrade


# # Cleanup
# $HOME/.dotjitsu/bin/hr -
# echo "‚ú® brew cleanup"
# /opt/homebrew/bin/brew cleanup

# Cache API-reponses
$HOME/.dotjitsu/bin/hr -
echo "‚ú® brew API"
echo

mkdir -p ~/.config/cache && cd "$_"

/opt/homebrew/bin/wget https://formulae.brew.sh/api/formula.json -O brew-formula.json.tmp -t 3 -q && mv brew-formula.json.tmp brew-formula.json
/opt/homebrew/bin/wget https://formulae.brew.sh/api/cask.json -O brew-cask.json.tmp -t 3 -q && mv brew-cask.json.tmp brew-cask.json

cat brew-formula.json | /opt/homebrew/bin/jq '.[] | "\(.name) | \(.desc) | \(.homepage)"' \
| /opt/homebrew/bin/sd '"' '' | /opt/homebrew/bin/sd 'null' '' | column -t -s'|' > brew-formula.txt

cat brew-cask.json | /opt/homebrew/bin/jq '.[] | "\(.token) | \(.desc) | \(.homepage)"' \
| /opt/homebrew/bin/sd '"' '' | /opt/homebrew/bin/sd 'null' '' | column -t -s'|' > brew-cask.txt

# if [ -t 1 ] ; then
#   # Install Caskfile formulas (only if interactive shell)
#   $HOME/.dotjitsu/bin/hr -
#   echo "‚ú® brew bundle (Caskfile)"
#   /opt/homebrew/bin/brew -v bundle --file=~/.dotjitsu/Caskfile
#  fi


$HOME/.dotjitsu/bin/hr -


rm -f /opt/homebrew/share/zsh/site-functions/_git

echo ""
echo "All done! Enjoy a cold one! üç∫ "
echo ""
