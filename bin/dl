#!/usr/bin/env bash

set -euo pipefail

#
# Argument parsing
#
CI=false
URL=""
OUTPUT=""
TTL=""

while [ "$#" -gt 0 ]; do
  case "$1" in
    -o) OUTPUT="$2"; shift 2;;
    -ttl) TTL="$2"; shift 2;;
    -ci) CI="true"; shift 1;;

    --output=*) OUTPUT="${1#*=}"; shift 1;;
    --ttl=*) TTL="${1#*=}"; shift 1;;
    --ci=*) CI="${1#*=}"; shift 1;;
    --output|--ttl|--ci) echo "$1 requires an argument" >&2; exit 1;;

    -*) echo "unknown option: $1" >&2; exit 1;;
    *) URL="$1"; shift 1;;
  esac
done

# Validate that URL is provided
if [[ -z "$URL" ]]; then
  echo "Error: URL is required" >&2
  echo "Usage: $(basename "$0") [options] <URL>" >&2
  echo "Options:" >&2
  echo "  -o, --output=FILE    Output filename" >&2
  echo "  -ttl SECONDS         Time to live (reserved for future use)" >&2
  echo "  -ci, --ci            CI mode (no colors)" >&2
  exit 1
fi

# Setup trap to cleanup temp directory on exit or error
cleanup() {
  local exit_code=$?
  if [[ -n "${TEMPDIR:-}" ]] && [[ -d "$TEMPDIR" ]]; then
    rm -rf "$TEMPDIR"
  fi
  exit $exit_code
}
trap cleanup EXIT

# Color codes - only use colors if we have a TTY and not in CI mode
if [[ -t 1 ]] && [[ "$CI" != "true" ]]; then
  readonly COLOR_BLUE='\033[0;34m'
  readonly COLOR_GREEN='\033[0;32m'
  readonly COLOR_RESET='\033[0m'
else
  readonly COLOR_BLUE=''
  readonly COLOR_GREEN=''
  readonly COLOR_RESET=''
fi

#
# Helpers
#

time-now() {
  date +%s.%N
}

benchmark() {
  local start=$1
  local end=${2:-$(time-now)}
  # Use native bash arithmetic instead of bc
  printf '%.2f\n' "$(echo "$end - $start" | bc -l)"
}

touch2() {
  mkdir -p "$(dirname "$1")" && touch "$1"
}

#
# Main
#

DIR=$(pwd)
# Extract filename from URL, removing query parameters
BASENAME="${URL##*/}"
BASENAME="${BASENAME%\?*}"
OUTPUT=${OUTPUT:-$BASENAME}
TEMPDIR=$(mktemp -d)

# Precreate some fancy path (i.e a/b/c/100.zip)
touch2 "$TEMPDIR/$OUTPUT"
cd "$TEMPDIR"

if [[ "$CI" == "true" ]]; then
  args='--no-progress-meter --silent'
else
  args='--progress-bar'
fi

start=$(time-now)

echo -e "· Downloading ${COLOR_GREEN}${OUTPUT}${COLOR_RESET} from ${COLOR_BLUE}${URL}${COLOR_RESET}"

COLUMNS=80 curl \
  $args \
  --disable \
  --show-error \
  --location \
  --keepalive \
  --connect-timeout 10 \
  --retry 2 \
  --fail-with-body \
  --compressed \
  -o "${OUTPUT}" \
  "${URL}" 2>&1

code=$?

if [ $code -ne 0 ]; then
  echo "❌ $URL"
  exit $code
fi

cd "$DIR"
touch2 "$OUTPUT"
mv "$TEMPDIR/$OUTPUT" "$OUTPUT"

# stop=$(benchmark $start)

# if [[ "$CI" == "true" ]]; then
#   # SIZE=$(du -bh $OUTPUT | xargs | cut -d ' ' -f1)
#   # echo "DONE ... in ${stop}s. $SIZE"
#   echo "DONE ... in ${stop}s."
# fi
